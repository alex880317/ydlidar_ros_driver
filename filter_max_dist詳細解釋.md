# filter_max_dist 參數詳細解釋（含圖解）

## 核心概念

`filter_max_dist` 不是「兩個點之間的距離」，而是**「原點到兩個連續點連線的垂直距離」**（策略1）或**「兩點連線在座標軸上的截距」**（策略2）。

---

## 策略 1：角度距離法（filter_strategy = 1）

### 計算的是什麼？

**原點 (0, 0) 到「兩個連續雷達點連成的直線」的垂直距離**

### 圖解說明

```
                    y 軸
                     |
                     |
           點1 ●     |     點2 ●
              (x1,y1)|     (x2,y2)
                     |      /
                     |     /  連成的直線
                     |    /
                     |   /
                     |  /
                     | / 垂直距離 d ← 這就是 filter_max_dist 要比較的值
                     |/
    ────────────────●────────────────── x 軸
                雷達原點 (0,0)
```

**計算過程**：
1. 將兩個雷達點從極座標（角度、距離）轉換為直角座標
2. 計算兩點連成的直線
3. 計算原點 (0,0) 到這條直線的**垂直距離**
4. 如果這個距離 < `filter_max_dist` → 判定為拖尾點

### 實際例子

假設雷達掃到兩個連續點：
```
點1：距離 = 2.0 米，角度 = 10°
點2：距離 = 2.1 米，角度 = 10.5°

轉換為直角座標：
點1 = (2.0*cos(10°), 2.0*sin(10°)) ≈ (1.97, 0.35)
點2 = (2.1*cos(10.5°), 2.1*sin(10.5°)) ≈ (2.07, 0.38)

兩點連線的方程式計算
原點到連線的垂直距離 ≈ 0.03 米
```

如果 `filter_max_dist = 0.05`：
- **距離 = 0.03 < 0.05** → **判定為拖尾點，過濾**

如果 `filter_max_dist = 0.02`：
- **距離 = 0.03 > 0.02** → **不判定為拖尾點，保留**

---

## 策略 2：截距法（filter_strategy = 2）⭐ 推薦

### 計算的是什麼？

**兩個連續點連成的直線在 x 軸和 y 軸上的截距，取較小的那個**

### 圖解說明

#### 情況 1：x 軸截距較小

```
                    y 軸
                     |
                     |
           點1 ●     |
              |      |
              |      |
              |      |
              |      |
              |      |
    ──────────●──────●────────────────── x 軸
              點2     x 軸截距 (min) ← 這就是 filter_max_dist 要比較的值
            y 軸截距
```

#### 情況 2：y 軸截距較小

```
                    y 軸
                     |      y 軸截距 (min) ← 這就是 filter_max_dist 要比較的值
           點1 ●─────●──────
              |      |    點2
              |      |
              |      |
              |      |
    ──────────●────────────────────────── x 軸
          雷達原點 (0,0)
```

#### 完整示意圖

```
        雷達掃描視角（俯視圖）
        
                    y ↑
                     |
             點1 ●   |
               /|    |
              / |    |
             /  |    |
            /   |    |
           /    |    |
          /     |    |
         /      |    |
        /       |    |
       ●───────┼────●──→ x
      點2      │   點3
              │
           原點 ● (0,0)
           
計算：點1 和 點2 連線的截距
- x 軸截距：直線與 x 軸交點的 x 座標值
- y 軸截距：直線與 y 軸交點的 y 座標值
- 取兩者的最小值（絕對值）

如果最小截距 < filter_max_dist → 判定為拖尾
```

### 計算公式（策略 2）

```cpp
// 點1: (x1, y1) = 極座標轉直角座標 (angle1, range1)
// 點2: (x2, y2) = 極座標轉直角座標 (angle2, range2)

// 計算直線方程式：通過點1和點2
// 一般式：Ax + By + C = 0

// x 軸截距 = |(y1*x2 - y2*x1) / (x2 - x1)|
// y 軸截距 = |(y1*x2 - y2*x1) / (y2 - y1)|

min_intercept = min(x軸截距, y軸截距)

if (min_intercept < filter_max_dist) {
    標記為拖尾點
}
```

### 實際例子

假設雷達掃到兩個連續點：

```
點1：距離 = 0.05 米，角度 = 45°
     → 直角座標 (0.035, 0.035)

點2：距離 = 0.06 米，角度 = 45.3°
     → 直角座標 (0.042, 0.042)

兩點連線的截距計算：
- x 軸截距 ≈ 0.02 米
- y 軸截距 ≈ 0.02 米
- 最小截距 = 0.02 米
```

如果 `filter_max_dist = 0.05`：
- **截距 = 0.02 < 0.05** → **判定為拖尾點，過濾**

如果 `filter_max_dist = 0.01`：
- **截距 = 0.02 > 0.01** → **不判定為拖尾點，保留**

---

## 拖尾現象示意圖

### 正常物體掃描

```
        雷達原點
           ●
           │
           │ 掃描方向 →
           │
     牆壁  │
    ════════════════
           │
           │
           
掃描結果：
點1 ●────● 點2 ────● 點3 ────● 點4
   距離:2.0m  2.1m     2.0m     2.1m

點1-點2 連線的截距：較大（例如 1.8 米）
→ 不會被過濾 ✅
```

### 強光拖尾掃描

```
        雷達原點
           ●
           │
           │ 強光反射
           │
           │
           
掃描結果（拖尾點）：
點1 ● 點2 ● 點3 ● 點4 ● 點5
   0.05m 0.06m 0.07m 0.08m 0.09m

點1-點2 連線的截距：很小（例如 0.02 米）
→ 會被過濾 ❌
```

---

## 視覺化對比

### 正常物體 vs 拖尾點

#### 正常物體（牆壁）

```
        雷達原點
           ●
           │
           │     ● 點1 (距離 2.0m)
           │    /
           │   /
           │  /  連線
           │ /   
           │/    
    ───────┼──────────── 牆壁
           │\    
           │ \   連線截距很大（例如 1.5 米）
           │  \  → 不會被過濾
           │   \
           │    ● 點2 (距離 2.1m)
```

#### 拖尾點（強光干擾）

```
        雷達原點
           ●
           │\
           │ \  
           │  \  連線
           │   \
           │    \
           │     ● 點1 (距離 0.05m)
           │      ● 點2 (距離 0.06m)
           │       ● 點3 (距離 0.07m)
           │
    ───────┼────────────
           │
           
連線截距很小（例如 0.02 米）
→ 會被過濾
```

---

## 參數調整的視覺效果

### filter_max_dist = 0.05（預設值）

```
截距 < 0.05 米 → 過濾
截距 ≥ 0.05 米 → 保留

過濾範圍：│──────●──────│
         0.0   0.05   0.10   0.15   米
```

### filter_max_dist = 0.10（寬鬆）

```
截距 < 0.10 米 → 過濾
截距 ≥ 0.10 米 → 保留

過濾範圍：│──────────────●──────│
         0.0             0.10   0.15   米
         
更寬鬆，過濾更少點
```

### filter_max_dist = 0.02（嚴格）

```
截距 < 0.02 米 → 過濾
截距 ≥ 0.02 米 → 保留

過濾範圍：│──●──────────────│
         0.0 0.02   0.10   0.15   米
         
更嚴格，過濾更多點
```

---

## 實際判斷流程（策略 2）

```
開始掃描
    ↓
獲取連續兩個點：點1 和 點2
    ↓
轉換為直角座標：(x1, y1) 和 (x2, y2)
    ↓
計算兩點連線的方程式
    ↓
計算 x 軸截距
    ↓
計算 y 軸截距
    ↓
取最小值：min_intercept = min(|x截距|, |y截距|)
    ↓
判斷：min_intercept < filter_max_dist ?
    ├─ 是 → 標記為拖尾點，過濾 ❌
    └─ 否 → 保留 ✅
```

---

## 數學公式說明

### 兩點連線的截距計算

假設兩個點：
- 點1：直角座標 (x₁, y₁)
- 點2：直角座標 (x₂, y₂)

**直線方程式**：
```
(y₂ - y₁)x - (x₂ - x₁)y + (x₂ - x₁)y₁ - (y₂ - y₁)x₁ = 0

可寫成：Ax + By + C = 0
其中：
A = (y₂ - y₁)
B = -(x₂ - x₁)
C = (x₂ - x₁)y₁ - (y₂ - y₁)x₁
```

**x 軸截距**（y = 0 時）：
```
x_intercept = -C/A = (y₁x₂ - y₂x₁) / (x₂ - x₁)
```

**y 軸截距**（x = 0 時）：
```
y_intercept = -C/B = (y₁x₂ - y₂x₁) / (y₂ - y₁)
```

**最小截距**：
```
min_intercept = min(|x_intercept|, |y_intercept|)
```

---

## 實際應用示例

### 示例 1：拖尾點（會被過濾）

```
點1：角度 = 90°,  距離 = 0.05 米 → (0, 0.05)
點2：角度 = 90.2°, 距離 = 0.06 米 → (0.001, 0.06)

連線幾乎垂直，x 軸截距很小：
min_intercept ≈ 0.01 米

如果 filter_max_dist = 0.05：
0.01 < 0.05 → 過濾 ❌
```

### 示例 2：正常點（不會被過濾）

```
點1：角度 = 0°,   距離 = 2.0 米 → (2.0, 0)
點2：角度 = 0.5°, 距離 = 2.1 米 → (2.1, 0.018)

連線與 x 軸截距：
min_intercept ≈ 2.0 米

如果 filter_max_dist = 0.05：
2.0 > 0.05 → 保留 ✅
```

---

## 關鍵理解總結

| 項目 | 說明 |
|------|------|
| **不是** | 兩個點之間的距離 |
| **而是** | 兩點連線在座標軸上的截距（策略2） |
| **比較** | 截距 < `filter_max_dist` → 過濾 |
| **預設值** | 0.05 米（5 公分） |
| **意義** | 拖尾點的連線通常接近原點，截距很小 |

### 記憶要點

1. **值越小** = 過濾越嚴格（更容易判定為拖尾）
2. **值越大** = 過濾越寬鬆（不容易判定為拖尾）
3. **0.05 米** = 如果連線截距 < 5 公分，就認為可能是拖尾

### 調整建議

- **看到拖尾沒過濾** → 減小值（例如 0.03）
- **正常點被誤刪** → 增大值（例如 0.08）

---

## 與 Windows GUI 工具的對應

Windows LidarViewer.exe 中的「拖尾濾波」功能：
- 內部使用相同的算法
- 自動調整 `filter_max_dist` 參數
- 在 ROS 中需要手動設置此參數

您當前設置 `filter_max_dist = 10.0` 表示：
- 截距 < 10 米才會過濾
- 這是一個非常寬鬆的設置（幾乎不會過濾）
- 如果仍想過濾拖尾，建議改為 0.05 ~ 0.10
