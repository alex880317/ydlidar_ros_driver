# 拖尾濾波參數詳細說明

## 概述

拖尾濾波（StrongLightFilter）用於過濾強光干擾產生的拖尾噪點。這些參數控制濾波器的行為和敏感度。

---

## 參數列表

### 1. `enable_strong_light_filter` (bool)

**作用**：啟用或禁用拖尾濾波功能

- `true`：啟用拖尾濾波，會過濾掉檢測到的拖尾噪點
- `false`：禁用拖尾濾波，輸出原始掃描數據

**預設值**：`false`

**建議**：在強光環境或出現拖尾噪點時設為 `true`

---

### 2. `filter_strategy` (int)

**作用**：選擇濾波算法策略

- **1 = 角度距離法（FS_1）**
  - 基於連續點之間的距離和角度變化來檢測拖尾
  - 計算兩點連線到原點的距離，以及兩線段的夾角
  - 適用於：對角度變化敏感的情況

- **2 = 截距法（FS_2）** ⭐ **推薦**
  - 基於兩點連線在 x、y 軸上的截距來檢測拖尾
  - 計算最小截距，如果小於閾值則認為是噪點
  - 適用於：大多數情況，性能更好

**預設值**：`2`（截距法）

**建議**：一般使用截距法（策略 2），如果效果不理想再嘗試角度距離法

---

### 3. `filter_max_dist` (double)

**作用**：最大距離閾值，單位：**米**

**工作原理**：
- **策略 1（角度距離法）**：判斷兩點連線到原點的距離
  - 如果距離 < `filter_max_dist` 且角度 < `filter_max_angle`，則認為可能是拖尾點
- **策略 2（截距法）**：判斷兩點連線在 x、y 軸上的最小截距
  - 如果最小截距 < `filter_max_dist`，則認為是噪點

**預設值**：`0.05` 米（5 公分）

**調整建議**：
- **過濾太多**（誤刪有效點）：**增大**此值（例如 0.08 或 0.10）
- **過濾太少**（仍有拖尾點）：**減小**此值（例如 0.03 或 0.02）
- **TG30 的測量範圍較大（最大 50 米）**：建議值 `0.05` ~ `0.10` 米

**實際意義**：
- 拖尾點通常距離很近或變化異常
- 這個值表示「如果連續點的幾何特徵小於此閾值，很可能是拖尾」

---

### 4. `filter_max_angle` (double)

**作用**：最大角度閾值，單位：**度**（僅在策略 1 中使用）

**工作原理**（僅策略 1）：
- 計算連續兩點形成的線段與原點的夾角
- 如果角度 < `filter_max_angle` 且距離 < `filter_max_dist`，則認為是拖尾點

**預設值**：`12.0` 度

**調整建議**：
- **過濾太多**：**增大**此值（例如 15.0 或 20.0）
- **過濾太少**：**減小**此值（例如 8.0 或 10.0）
- **注意**：此參數僅在 `filter_strategy=1` 時有效

**實際意義**：
- 拖尾點的角度變化通常很小
- 正常物體反射的角度變化較大

---

### 5. `filter_min_noise` (int)

**作用**：最小連續噪點數量

**工作原理**：
- 濾波器會檢測連續的潛在噪點
- 只有當**連續噪點數量 ≥ `filter_min_noise`** 時，才會將這些點標記為噪點並過濾
- 如果連續噪點數量 < `filter_min_noise`，則保留這些點

**預設值**：`3` 個點

**調整建議**：
- **過濾太多**（誤刪有效點）：**增大**此值（例如 5 或 8）
- **過濾太少**（仍有拖尾點）：**減小**此值（例如 2 或 1）
- **注意**：設為 1 可能會過度過濾，建議至少為 2

**實際意義**：
- 拖尾通常是連續多個點，而不是單個點
- 此參數用於區分「真正的拖尾」和「偶發的異常點」
- 避免誤刪單個或少量異常但有效的測量點

---

## 參數調整指南

### 場景 1：強光干擾嚴重，拖尾很多

```xml
<param name="enable_strong_light_filter"  type="bool"   value="true"/>
<param name="filter_strategy"             type="int"    value="2"/>
<param name="filter_max_dist"             type="double" value="0.03"/>  <!-- 更嚴格 -->
<param name="filter_max_angle"            type="double" value="10.0"/>
<param name="filter_min_noise"            type="int"    value="2"/>     <!-- 更敏感 -->
```

### 場景 2：輕微拖尾，需要保守過濾

```xml
<param name="enable_strong_light_filter"  type="bool"   value="true"/>
<param name="filter_strategy"             type="int"    value="2"/>
<param name="filter_max_dist"             type="double" value="0.08"/>  <!-- 更寬鬆 -->
<param name="filter_max_angle"            type="double" value="15.0"/>
<param name="filter_min_noise"            type="int"    value="5"/>     <!-- 更保守 -->
```

### 場景 3：預設配置（平衡）

```xml
<param name="enable_strong_light_filter"  type="bool"   value="true"/>
<param name="filter_strategy"             type="int"    value="2"/>
<param name="filter_max_dist"             type="double" value="0.05"/>
<param name="filter_max_angle"            type="double" value="12.0"/>
<param name="filter_min_noise"            type="int"    value="3"/>
```

---

## 測試建議

### 步驟 1：啟動帶濾波的驅動

```bash
roslaunch ydlidar_ros_driver TG.launch
```

### 步驟 2：觀察效果

在 RViz 中查看 `/scan` 話題，對比：
- **濾波前後**的點雲變化
- **拖尾噪點是否被過濾**
- **有效點是否被誤刪**

### 步驟 3：調整參數

根據觀察結果，逐步調整參數：
1. 先調整 `filter_max_dist`（影響最大）
2. 再調整 `filter_min_noise`（控制敏感度）
3. 如果使用策略 1，可調整 `filter_max_angle`

### 步驟 4：查看日誌

啟動時會看到類似訊息：
```
拖尾濾波已啟用 - 策略: 2, 最大距離: 0.050 m, 最大角度: 12.0°, 最小噪點: 3
```

---

## 技術原理

### 拖尾現象

當雷達遇到強反射物體（如鏡面、金屬表面）時，會產生：
- 連續的異常測量點
- 距離變化異常
- 角度分佈異常
- 這些點形成「拖尾」效果

### 濾波原理

**策略 1（角度距離法）**：
1. 按角度排序點
2. 計算連續點之間的距離和角度變化
3. 如果距離和角度都小於閾值，標記為拖尾

**策略 2（截距法）**：
1. 按角度排序點
2. 計算連續兩點連線在 x、y 軸的截距
3. 如果最小截距小於閾值，標記為噪點
4. 標記連續噪點序列，超過最小數量才過濾

---

## 與 Windows GUI 工具的對應

Windows LidarViewer.exe 中的「拖尾濾波」功能對應：
- `enable_strong_light_filter = true`
- 使用相同的 SDK 濾波算法
- 參數會在 GUI 中自動調整，ROS 中需要手動設置

---

## 常見問題

**Q: 過濾太激進，誤刪有效點？**
A: 增大 `filter_max_dist` 和 `filter_min_noise`

**Q: 仍有拖尾點沒被過濾？**
A: 減小 `filter_max_dist` 或 `filter_min_noise`

**Q: 兩種策略哪個更好？**
A: 一般推薦策略 2（截距法），性能更好

**Q: 如何完全禁用濾波？**
A: 設置 `enable_strong_light_filter = false`

