# TG30 強度數據評估報告

## 結論

**TG30 在預設模式下（intensity=false）沒有真實的強度數據。**

## 詳細分析

### 1. 數據結構

從 SDK 代碼可以看到：
- `LaserPoint` 結構體包含 `intensity` 欄位（float 類型）
- 原始數據從 `node_info.qual` 轉換而來：`intensity = static_cast<float>(global_nodes[i].qual);`

### 2. TG30 數據解析流程

#### 當 `intensity=false`（預設模式）時：

在 `YDlidarDriver.cpp::parseNodeFromeBuffer()` 函數中：

```cpp
else // 如果不带强度信息
{
    (*node).dist = packages.nodes[nodeIndex];  // 只解析距離
    // 注意：對於 TOF 雷達（TG30），這裡沒有設置 qual 值
}
```

結果：
- `(*node).qual` 保持初始值 `Node_Default_Quality = 10`
- 所有點的 `intensity` 都固定為 **10.0**
- **這不是真實的強度數據，無法用於濾波**

#### 當 `intensity=true` 時：

代碼嘗試解析 TOF 強度數據包：
```cpp
if (m_intensities) {
    if (isTOFLidar(m_LidarType)) {
        (*node).qual = tof_package.nodes[nodeIndex].qual;  // 嘗試讀取強度
        (*node).dist = tof_package.nodes[nodeIndex].dist;
    }
}
```

但問題：
- TG30 硬體不支持強度數據輸出
- 數據包格式仍然是 2 字節/點（無強度）
- SDK 按照 3 字節/點（有強度）格式解析，導致：
  - **Check Sum 校驗失敗**
  - 數據解析錯誤

### 3. 協議層面的驗證

從 YDLidar-SDK Communication Protocol 文檔：

- **無強度模式**：`Si(2B)` - 每個採樣點 2 字節，只有距離
- **有強度模式**：`Si(3B)` - 每個採樣點 3 字節，包含強度 + 距離

TG30 屬於 TOF 類型雷達，協議定義：
- TOF 雷達**可以**有強度數據（`tof_node` 結構：`uint16_t qual + uint16_t dist`）
- 但 **TG30 具體型號不支持**

### 4. 實際測試建議

要確認 TG30 是否有強度數據，可以：

#### 方法 1：檢查 ROS 話題中的 intensity 值
```bash
rostopic echo /scan | grep -A 50 "intensities:"
```
如果所有值都是相同的（很可能是 10.0），說明沒有真實強度數據。

#### 方法 2：檢查原始 node_info.qual 值
在 ROS 驅動中添加日誌輸出，查看 `scan.points[i].intensity` 的實際值。

## 替代方案

由於 TG30 **沒有強度數據**，無法直接使用強度閾值進行濾波。

### 建議方案：

1. **使用拖尾濾波器（StrongLightFilter）**
   - 雖然沒有強度數據，但可以基於：
     - 距離變化率
     - 角度變化
     - 截距計算
   - 這些方法在 SDK 的 `StrongLightFilter` 中已實現

2. **基於幾何特徵的濾波**
   - 檢測連續點之間的距離突變
   - 檢測角度和距離的組合異常
   - 類似拖尾濾波的原理

3. **修改 ROS 驅動添加濾波功能**
   - 在數據發布前應用 `StrongLightFilter`
   - 這是最接近 Windows GUI 工具的方案

## 總結

| 項目 | 結果 |
|------|------|
| TG30 是否有強度數據？ | ❌ 否（預設模式下所有點 intensity = 10） |
| 能否使用強度閾值濾波？ | ❌ 否（沒有真實強度值） |
| 能否使用拖尾濾波？ | ✅ 是（基於幾何特徵，不依賴強度） |
| 推薦方案 | 修改 ROS 驅動集成 StrongLightFilter |

